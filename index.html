<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BUGminerbot - Watch2Earn</title>

  <!-- Firebase CDN (Correct) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,#0f0f0f,#2b2b2b);color:#fff;padding:1rem;display:flex;flex-direction:column;align-items:center;min-height:100vh}
    .telegram-banner{background:#00ff88;color:#000;padding:.8rem 1.2rem;border-radius:10px;text-align:center;font-weight:700;text-decoration:none;margin-bottom:1rem;box-shadow:0 0 15px rgba(0,255,136,.4)}
    .video-section{width:100%;max-width:900px;margin-bottom:1.25rem;background:rgba(255,255,255,.04);border-radius:12px;padding:1rem;box-shadow:0 0 10px rgba(0,0,0,.6)}
    h2{text-align:center;color:#00ff88;margin-bottom:.5rem}
    .btn{background:#00ff88;color:#000;padding:.8rem 1.5rem;border:none;border-radius:10px;font-weight:700;cursor:pointer;display:block;width:100%;max-width:400px;margin:.5rem auto;transition:all .2s}
    .btn:hover:not(:disabled){background:#00cc70;transform:scale(1.02)}
    .btn:disabled{background:#555;cursor:not-allowed;opacity:.6}
    .countdown{text-align:center;color:#00ff88;margin-top:.5rem}
    .download-wrap{display:none;margin-top:1rem;text-align:center}
    .note{text-align:center;color:#ccc;font-size:.9rem;margin-top:8px}
    .locked-overlay{text-align:center;padding:1.3rem;background:rgba(255,255,255,.04);border-radius:12px;box-shadow:0 0 12px rgba(0,255,136,.12);margin-top:1rem;display:none;max-width:900px}
    .ref-box{background:rgba(0,0,0,.25);padding:.8rem;border-radius:8px;margin-top:.6rem}
    .small{font-size:.9rem;color:#ddd}
    .ref-link{background:#111;padding:.5rem;border-radius:6px;display:inline-block;margin-top:.5rem;cursor:pointer}
    #loading, #error {text-align:center;margin:2rem;color:#aaa;}
    #error {color:#ff5555;display:none;}
  </style>
</head>
<body>

  <a href="https://t.me/+bKHfwO7GUUwxZTA1" class="telegram-banner" target="_blank">ðŸ”¥ Join Our Official Telegram Channel ðŸ”¥</a>

  <div id="loading">Loading...</div>
  <div id="error"></div>
  <div id="userInfo" style="display:none;margin:1rem 0;"></div>
  <div id="refStats" class="small" style="display:none;color:#ffcc00;font-weight:bold;"></div>

  <div id="videos-container"></div>

  <!-- Monetag SDK -->
  <script src='//libtl.com/sdk.js' data-zone='9903296' data-sdk='show_9903296'></script>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAghzdqVABzhmrGR3W6XiXsUMCH0Awuhcw",
      authDomain: "watch2earn-d0126.firebaseapp.com",
      projectId: "watch2earn-d0126",
      storageBucket: "watch2earn-d0126.firebasestorage.app",
      messagingSenderId: "841118979263",
      appId: "1:841118979263:web:8dfdfdf60e30a8d875220a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const BOT_USERNAME = 'BUGminerbot';
    const TOTAL_ADS = 2;
    const REQUIRED_REFERRALS = 3;
    const TOTAL_VIDEOS = 5;

    const driveLinks = {
      1: "https://drive.google.com/uc?export=download&id=190F4MriUa_w4Rf8o07eS8U4Ncvck2K51",
      2: "https://drive.google.com/uc?export=download&id=1kJ4sjDWf61WplqPur2I3R48bTjkRsnN1",
      3: "https://drive.google.com/uc?export=download&id=1ZCgEuAEq55aSAKKEVCKnskWVWP29eol_",
      4: "https://drive.google.com/uc?export=download&id=1kPl_yU36ATVQQP8GkvziWlJwZMddy05J",
      5: "https://drive.google.com/uc?export=download&id=1IxFE1NezW86UHPFs5IxL-YVT5nDUf_qY"
    };

    const tg = window.Telegram?.WebApp;
    tg?.ready();
    const user = tg?.initDataUnsafe?.user;
    const startParam = tg?.initDataUnsafe?.start_param || '';
    const userId = user?.id?.toString() || 'guest_' + Date.now();

    let currentUser = null;

    function showError(msg) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').innerText = msg;
      document.getElementById('error').style.display = 'block';
    }

    auth.signInAnonymously()
      .then(cred => { currentUser = cred.user; initApp(); })
      .catch(err => showError('Auth Error: ' + err.message));

    async function initApp() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('userInfo').style.display = 'block';
      document.getElementById('userInfo').innerText = `Hi ${user?.first_name || 'User'}!`;

      const userRef = db.collection('users').doc(userId);

      // Handle Referral
      if (startParam && startParam.startsWith('ref_')) {
        const referrerId = startParam.replace('ref_', '');
        const doc = await userRef.get();
        if (!doc.exists) {
          await userRef.set({ adsWatched: {}, referrals: [], referredBy: referrerId });
          await db.collection('users').doc(referrerId).update({
            referrals: firebase.firestore.FieldValue.arrayUnion(userId)
          });
          tg?.showAlert('Referral Successful! You got 3 free videos!');
        }
      }

      // Load Data
      const doc = await userRef.get();
      const data = doc.exists ? doc.data() : { adsWatched: {}, referrals: [] };
      const refCount = data.referrals?.length || 0;

      document.getElementById('refStats').style.display = 'block';
      document.getElementById('refStats').innerText = `Referrals: ${refCount}/${REQUIRED_REFERRALS}`;

      // Unlock Videos 4 & 5
      if (refCount >= REQUIRED_REFERRALS) {
        [4,5].forEach(i => {
          const btn = document.getElementById(`adBtn${i}`);
          if (btn) btn.disabled = false;
          const cnt = document.getElementById(`countdown${i}`);
          if (cnt) cnt.innerText = 'Watch 2 ads';
          const lock = document.querySelector(`#video${i} .locked`);
          if (lock) lock.style.display = 'none';
        });
      }

      // Create Videos
      for (let i = 1; i <= TOTAL_VIDEOS; i++) {
        createVideoSection(i, data.adsWatched[i] || 0, refCount >= REQUIRED_REFERRALS || i <= 3);
      }

      // Share Button
      const shareBtn = document.createElement('button');
      shareBtn.className = 'btn';
      shareBtn.textContent = 'Share Referral Link';
      shareBtn.onclick = () => {
        const link = `https://t.me/${BOT_USERNAME}?startapp=ref_${userId}`;
        tg?.shareUrl(link, 'Join & unlock 3 free videos!');
      };
      document.body.appendChild(shareBtn);
    }

    function createVideoSection(id, adsWatched, isActive) {
      const section = document.createElement('div');
      section.className = 'video-section';
      section.id = `video${id}`;
      section.innerHTML = `
        <h2>Post Number ${id} ${!isActive ? '<span class="locked">(Need 3 Referrals)</span>' : ''}</h2>
        <button class="btn" id="adBtn${id}" ${!isActive ? 'disabled' : ''}>Watch Ad</button>
        <div class="countdown" id="countdown${id}">${adsWatched >= TOTAL_ADS ? 'Unlocked!' : `Ads: ${adsWatched}/${TOTAL_ADS}`}</div>
        <div class="download-wrap" id="player${id}" style="display:${adsWatched >= TOTAL_ADS ? 'block' : 'none'};">
          <button class="btn" onclick="window.open('${driveLinks[id]}','_blank')">Download Now</button>
        </div>
      `;
      document.getElementById('videos-container').appendChild(section);

      if (isActive) {
        const btn = document.getElementById(`adBtn${id}`);
        const cnt = document.getElementById(`countdown${id}`);
        const dl = document.getElementById(`player${id}`);

        btn.onclick = async () => {
          btn.disabled = true;
          try {
            await show_9903296();
            adsWatched++;
            await db.collection('users').doc(userId).update({[`adsWatched.${id}`]: adsWatched});
            if (adsWatched >= TOTAL_ADS) {
              cnt.innerText = 'Unlocked!';
              dl.style.display = 'block';
              btn.style.display = 'none';
            } else {
              cnt.innerText = `Ads: ${adsWatched}/${TOTAL_ADS}`;
            }
          } catch (e) {
            alert('Ad failed. Try again.');
          }
          btn.disabled = false;
        };
      }
    }
  </script>
</body>
</html>
