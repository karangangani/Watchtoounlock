<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BUGminerbot - Watch2Earn v3.0</title>

  <!-- Telegram -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <!-- ADS -->
  <script src="//libtl.com/sdk.js" data-zone="9903296" data-sdk="show_9903296"></script>

  <style>
    body{margin:0;font-family:Arial;background:#111;color:#fff;padding:1rem;display:flex;flex-direction:column;align-items:center;min-height:100vh}
    .banner{background:#00ff88;color:#000;padding:1rem;border-radius:12px;font-weight:bold;margin-bottom:1rem;text-decoration:none;display:block;text-align:center;width:95%;}
    .ref-link-box{background:rgba(0,255,136,0.2);border:2px solid #00ff88;padding:1rem;border-radius:12px;margin:1rem 0;width:95%;text-align:center;}
    .ref-link{color:#00ff88;font-weight:bold;font-size:1.2rem;cursor:pointer;}
    .video{background:rgba(255,255,255,0.1);border-radius:12px;padding:1rem;margin:1rem 0;width:95%;max-width:900px;}
    .btn{background:#00ff88;color:#000;border:none;padding:14px;border-radius:10px;margin:10px auto;width:90%;font-weight:bold;display:block;font-size:1.1rem;}
    .btn:disabled{background:#555;opacity:0.6;}
    .count{color:#00ff88;margin:8px 0;text-align:center;font-size:1.1rem;}
    .locked{color:#ff5555;font-weight:bold;}
    #loading{margin:2rem;text-align:center;font-size:1.3rem;}
    .ref{color:#ffcc00;font-weight:bold;margin:10px 0;font-size:1.2rem;}
  </style>
</head>
<body>

<a href="https://t.me/+bKHfwO7GUUwxZTA1" class="banner" target="_blank">Join Our Official Telegram Channel</a>

<div id="loading">Loading Your Videos...</div>
<div id="userInfo" style="display:none;margin:1rem 0;font-size:1.4rem;font-weight:bold;"></div>
<div id="refStats" class="ref" style="display:none;"></div>

<div id="refLinkBox" class="ref-link-box" style="display:none;">
  <div>Your Unique Referral Link:</div>
  <div id="refLink" class="ref-link">Loading...</div>
  <div style="margin-top:8px;">Share → Friends Join → Unlock Post 4 & 5!</div>
</div>

<div id="videos-container"></div>

<script>
/* ---------------- FIREBASE CONFIG ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAghzdqVABzhmrGR3W6XiXsUMCH0Awuhcw",
  authDomain: "watch2earn-d0126.firebaseapp.com",
  projectId: "watch2earn-d0126",
  storageBucket: "watch2earn-d0126.firebasestorage.app",
  messagingSenderId: "841118979263",
  appId: "1:841118979263:web:8dfdfdf60e30a8d875220a"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* ---------------- CONSTANTS ---------------- */
const BOT = "BUGminerbot";
const REQUIRED_REFERRALS = 5;

const driveLinks = {
  1: "https://drive.google.com/uc?export=download&id=190F4MriUa_w4Rf8o07eS8U4Ncvck2K51",
  2: "https://drive.google.com/uc?export=download&id=1kJ4sjDWf61WplqPur2I3R48bTjkRsnN1",
  3: "https://drive.google.com/uc?export=download&id=1ZCgEuAEq55aSAKKEVCKnskWVWP29eol_",
  4: "https://drive.google.com/uc?export=download&id=1kPl_yU36ATVQQP8GkvziWlJwZMddy05J",
  5: "https://drive.google.com/uc?export=download&id=1IxFE1NezW86UHPFs5IxL-YVT5nDUf_qY"
};

/* ---------------- TELEGRAM ---------------- */
const tg = window.Telegram.WebApp;
tg.ready();
const user = tg.initDataUnsafe.user;
const userId = user?.id?.toString();

/* ---------------- USER DATA INIT ---------------- */
let userRef = null;
let userData = { referrals: [], completed: [], taps: {} };

auth.signInAnonymously().then(() => {
  userRef = db.collection("users").doc(userId);
  initApp();
}).catch(() => initApp());

/* ---------------- INIT APP ---------------- */
async function initApp() {
  document.getElementById("loading").style.display = "none";

  const doc = await userRef.get();
  if (doc.exists) userData = doc.data();

  userData.referrals ||= [];
  userData.completed ||= [];
  userData.taps ||= {};

  document.getElementById("userInfo").innerText = `Hi ${user?.first_name}!`;
  document.getElementById("userInfo").style.display = "block";

  document.getElementById("refStats").style.display = "block";
  document.getElementById("refStats").innerText =
    `Referrals: ${userData.referrals.length}/${REQUIRED_REFERRALS}`;

  const refLink = `https://t.me/${BOT}?startapp=ref_${userId}`;
  document.getElementById("refLink").innerText = refLink;
  document.getElementById("refLinkBox").style.display = "block";
  document.getElementById("refLink").onclick = () => {
    navigator.clipboard.writeText(refLink);
    tg.showAlert("Link Copied!");
  };

  for (let i = 1; i <= 5; i++) {
    const unlocked = i <= 3 || userData.referrals.length >= REQUIRED_REFERRALS;
    const completed = userData.completed.includes(i);
    const taps = userData.taps[i] || 0;

    createVideo(i, unlocked, completed, taps);
  }
}

/* ---------------- CREATE POST CARD ---------------- */
function createVideo(id, unlocked, completed, taps) {
  const div = document.createElement("div");
  div.className = "video";

  if (!unlocked) {
    div.innerHTML = `
      <h3>Post ${id} <span class="locked">(Locked — Need ${REQUIRED_REFERRALS} Referrals)</span></h3>
      <button class="btn" disabled>Locked</button>
    `;
  }

  else if (completed) {
    div.innerHTML = `
      <h3>Post ${id}</h3>
      <div class="locked">Already Unlocked</div>
    `;
  }

  else {
    div.innerHTML = `
      <h3>Post ${id}</h3>
      <button class="btn" id="ad${id}">Tap to Watch Ads</button>
      <div class="count" id="c${id}">Tap Count: ${taps}/3</div>
    `;

    const btn = div.querySelector(`#ad${id}`);
    const cnt = div.querySelector(`#c${id}`);

    btn.onclick = async () => {
      let count = userData.taps[id] || 0;

      count++;
      userData.taps[id] = count;

      cnt.innerText = `Tap Count: ${count}/3`;
      await userRef.update({ taps: userData.taps });

      // Tap 1, Tap 2 → Only show ads
      if (count < 3) {
        await show_9903296("pop");
        tg.showAlert(`Ad Shown (${count}/3). Now go back and tap again.`);
        return;
      }

      // Tap 3 → Unlock + Open link
      await show_9903296("pop");

      userRef.update({
        completed: firebase.firestore.FieldValue.arrayUnion(id)
      });

      cnt.innerHTML = '<span style="color:#00ff88;">Ads Completed! Opening Link...</span>';
      btn.style.display = "none";

      window.open(driveLinks[id], "_blank");
    };
  }

  document.getElementById("videos-container").appendChild(div);
}
</script>
</body>
</html>
