<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BUGminerbot - Watch2Earn</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body{margin:0;font-family:Arial;background:#000;color:#fff;padding:1rem;display:flex;flex-direction:column;align-items:center;min-height:100vh}
    .banner{background:#00ff88;color:#000;padding:1.2rem;border-radius:15px;font-weight:bold;margin:1rem auto 1.5rem;text-align:center;width:95%;max-width:500px;font-size:1.1rem;}
    .ref-link-box{background:rgba(0,255,136,0.15);border:2px solid #00ff88;padding:1.2rem;border-radius:15px;margin:1rem 0;width:95%;text-align:center;}
    .ref-link{color:#00ff88;font-weight:bold;font-size:1.3rem;cursor:pointer;}
    .video{background:rgba(255,255,255,0.08);border-radius:15px;padding:1.3rem;margin:1rem 0;width:95%;max-width:900px;}
    .btn{background:#00ff88;color:#000;border:none;padding:18px;border-radius:12px;margin:15px auto;width:90%;font-weight:bold;display:block;font-size:1.3rem;cursor:pointer;}
    .btn:disabled{background:#333;opacity:0.6;}
    .progress{color:#00ff88;font-size:1.4rem;font-weight:bold;text-align:center;margin:10px 0;}
    .count{color:#aaa;font-size:1.1rem;text-align:center;}
    .locked{color:#ff5555;font-weight:bold;}
    #loading{margin:3rem;text-align:center;font-size:1.5rem;color:#00ff88;}
    .ref{color:#ffcc00;font-weight:bold;margin:10px 0;font-size:1.3rem;text-align:center;}
  </style>
</head>
<body>

  <a href="https://t.me/+bKHfwO7GUUwxZTA1" class="banner" target="_blank">Join Our Official Channel</a>

  <div id="loading">Loading...</div>
  <div id="userInfo" style="display:none;font-size:1.6rem;font-weight:bold;margin:1rem;"></div>
  <div id="refStats" class="ref" style="display:none;"></div>

  <div id="refLinkBox" class="ref-link-box" style="display:none;">
    <div>Your Referral Link:</div>
    <div id="refLink" class="ref-link">Loading...</div>
    <div style="margin-top:10px;color:#aaa;">Share → 5 Friends = All Videos Free!</div>
  </div>

  <div id="videos-container"></div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAghzdqVABzhmrGR3W6XiXsUMCH0Awuhcw",
      authDomain: "watch2earn-d0126.firebaseapp.com",
      projectId: "watch2earn-d0126",
      storageBucket: "watch2earn-d0126.firebasestorage.app",
      messagingSenderId: "841118979263",
      appId: "1:841118979263:web:8dfdfdf60e30a8d875220a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const BOT = "BUGminerbot";
    const REQUIRED_REFERRALS = 5;

    const driveLinks = {
      1: "https://drive.google.com/uc?export=download&id=190F4MriUa_w4Rf8o07eS8U4Ncvck2K51",
      2: "https://drive.google.com/uc?export=download&id=1kJ4sjDWf61WplqPur2I3R48bTjkRsnN1",
      3: "https://drive.google.com/uc?export=download&id=1ZCgEuAEq55aSAKKEVCKnskWVWP29eol_",
      4: "https://drive.google.com/uc?export=download&id=1kPl_yU36ATVQQP8GkvziWlJwZMddy05J",
      5: "https://drive.google.com/uc?export=download&id=1IxFE1NezW86UHPFs5IxL-YVT5nDUf_qY"
    };

    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const user = tg.initDataUnsafe.user;
    const startParam = tg.initDataUnsafe.start_param || '';
    const userId = user?.id ? user.id.toString() : 'guest_' + Date.now();

    const userRef = db.collection('users').doc(userId);

    // Save user data
    userRef.set({
      username: user?.username ? '@' + user.username : user?.first_name || 'User',
      first_name: user?.first_name || 'User',
      lastSeen: new Date(),
      userId: userId
    }, { merge: true });

    // Popunder Ad
    function showAd() {
      return new Promise(resolve => {
        window.open('https://a.exoclick.com/popunder1000213.js', '_blank');
        setTimeout(resolve, 4000);
      });
    }

    async function initApp() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('userInfo').style.display = 'block';
      document.getElementById('userInfo').innerText = `Hi ${user?.first_name || 'Friend'}!`;

      let refCount = 0;

      // Referral handle
      if (startParam && startParam.startsWith('ref_')) {
        const referrerId = startParam.replace('ref_', '');
        if (referrerId !== userId && referrerId.length > 5) {
          const referrerRef = db.collection('users').doc(referrerId);
          const refSnap = await referrerRef.get();
          if (refSnap.exists) {
            await userRef.set({ referrer: referrerId }, { merge: true });
            await referrerRef.update({
              referrals: firebase.firestore.FieldValue.arrayUnion(userId)
            });
            tg.showAlert('Referral Successful! 3 Videos Unlocked!');
          }
        }
      }

      // Get referral count
      const snap = await userRef.get();
      if (snap.exists) {
        const data = snap.data();
        refCount = (data.referrals?.length || 0);
      }

      document.getElementById('refStats').style.display = 'block';
      document.getElementById('refStats').innerText = `Referrals: ${refCount}/5`;

      `;

      // Correct referral link
      const refLink = `https://t.me/\( {BOT}?startapp=ref_ \){userId}`;
      document.getElementById('refLinkBox').style.display = 'block';
      document.getElementById('refLink').innerText = refLink;
      document.getElementById('refLink').onclick = () => {
        navigator.clipboard.writeText(refLink);
        tg.showAlert('Link Copied!');
      };

      // Create 5 videos
      for (let i = 1; i <= 5; i++) {
        const unlocked = refCount >= 5 || i <= 3;
        createVideo(i, unlocked);
      }
    }

    function createVideo(id, unlocked) {
      const div = document.createElement('div');
      div.className = 'video';

      if (!unlocked) {
        div.innerHTML = `<h3>Video ${id} <span class="locked">(Need 5 Referrals)</span></h3>
          <button class="btn" disabled>Locked</button>`;
      } else {
        div.innerHTML = `
          <h3>Video ${id}</h3>
          <div class="progress" id="p${id}">Tap 3 Times → Watch Ads → Get Video</div>
          <button class="btn" id="b${id}">Watch 3 Ads to Unlock</button>
          <div class="count" id="c${id}">0/3 Ads Done</div>`;

        let count = 0;
        const btn = div.querySelector(`#b${id}`);
        const prog = div.querySelector(`#p${id}`);
        const cnt = div.querySelector(`#c${id}`);

        btn.onclick = async () => {
          if (count >= 3) {
            window.open(driveLinks[id], '_blank');
            tg.showAlert('Enjoy the video!');
            count = 0;
            cnt.innerText = '0/3 Ads Done';
            prog.innerText = 'Tap 3 Times → Watch Ads → Get Video';
            btn.innerText = 'Watch 3 Ads to Unlock';
            return;
          }

          btn.disabled = true;
          prog.innerText = `Ad ${count+1}/3 Loading...`;
          cnt.innerText = `${count+1}/3 Done`;

          await showAd();
          count++;
          cnt.innerText = `${count}/3 Done`;

          if (count === 3) {
            prog.innerHTML = '<span style="color:#00ff88">All 3 Ads Done! Tap to Open Video</span>';
            btn.innerText = 'OPEN VIDEO NOW';
          } else {
            prog.innerText = `Tap again for Ad ${count+1}/3`;
          }
          btn.disabled = false;
        };
      }
      document.getElementById('videos-container').appendChild(div);
    }

    // Start
    initApp().catch(e => {
      document.getElementById('loading').innerHTML = 'Error! Try again.';
      console.error(e);
    });
  </script>
</body>
</html>
